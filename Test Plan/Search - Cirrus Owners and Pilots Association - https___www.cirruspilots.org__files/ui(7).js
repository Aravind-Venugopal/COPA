(function(n){namespace("$.couto.mediamagnificent.widgets");n.couto.mediamagnificent.widgets.audioPlayer={register:function(t){function ci(){var u=this;u.url=ko.observable();u.fileUrl=ko.observable();u.mediaId=ko.observable(0);u.contentId=ko.observable("");u.contentTypeId=ko.observable("");u.galleryId=ko.observable(0);u.groupId=ko.observable(0);u.authorUserId=ko.observable(0);u.index=ko.observable();u.maxIndex=ko.observable();u.authorProfileUrl=ko.observable();u.authorAvatarUrl=ko.observable();u.authorDisplayName=ko.observable();u.description=ko.observable();u.hasDescription=ko.observable();u.galleryRssUrl=ko.observable();u.galleryName=ko.observable();u.galleryUrl=ko.observable();u.isSubscribed=ko.observable();u.isMinimized=ko.observable(!0);u.thumbnailUrlMinimized=ko.observable("");u.thumbnailUrlMaximized=ko.observable("");u.canCreateComment=ko.observable(!1);u.canDeleteComment=ko.observable(!1);u.comments=ko.observableArray();u.title=ko.observable();u.creator=ko.observable();u.dateFormatted=ko.observable();u.canBookmarkPost=ko.observable(!1);u.canUnBookmarkPost=ko.observable(!1);u.isBookmarked=ko.observable();u.rating=ko.observable(0);u.canRatePost=ko.observable(!1);u.continuousPlayEnabled=ko.observable(!1);u.randomPlayEnabled=ko.observable(!1);u.canDownloadPost=ko.observable(!1);u.downloads=ko.observable();u.fileSizeFormatted=ko.observable();u.views=ko.observable();u.tags=ko.observableArray();u.downloadUrl=ko.observable();u.shareUrl=ko.observable();u.canEditPost=ko.observable(!1);u.editUrl=ko.observable();u.canDeletePost=ko.observable(!1);u.userIsRegistered=ko.observable(!1);u.likeHtml=ko.observable("");u.moderateHtml=ko.observable("");u.isPlaying=ko.observable(!1);u.clearData=function(){u.url("");u.fileUrl("");u.mediaId(0);u.contentId("");u.contentTypeId("");u.galleryId(0);u.groupId(0);u.authorUserId(0);u.index(0);u.maxIndex(0);u.authorProfileUrl("");u.authorAvatarUrl("");u.authorDisplayName("");u.description("");u.hasDescription("");u.galleryRssUrl("");u.galleryName("");u.galleryUrl("");u.isSubscribed();u.isMinimized();u.thumbnailUrlMinimized("");u.thumbnailUrlMaximized("");u.canCreateComment(!1);u.canDeleteComment(!1);u.comments.removeAll();u.title("");u.creator("");u.dateFormatted("");u.canBookmarkPost(!1);u.canUnBookmarkPost(!1);u.isBookmarked();u.rating(0);u.canRatePost(!1);u.canDownloadPost(!1);u.downloads("");u.fileSizeFormatted("");u.views("");u.tags.removeAll();u.downloadUrl("");u.shareUrl("");u.canEditPost(!1);u.editUrl("");u.canDeletePost(!1);u.likeHtml("");u.moderateHtml("");u.isPlaying(!1)};u.currentUserIsAuthor=function(){return t.userId===u.authorUserId()};u.toggleBookmark=function(r,u){n(u.currentTarget).text("...");t.postViewModel.isBookmarked()?n.telligent.evolution.del({url:n.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/bookmark.json",data:{ContentId:t.postViewModel.contentId()},success:function(){t.postViewModel.isBookmarked(!1);i.updateMediaPostProperty(t.postViewModel.mediaId(),"IsBookmarked",!1)}}):n.telligent.evolution.post({url:n.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/bookmark.json",data:{ContentId:t.postViewModel.contentId(),ContentTypeId:t.postViewModel.contentTypeId()},success:function(){t.postViewModel.isBookmarked(!0);i.updateMediaPostProperty(t.postViewModel.mediaId(),"IsBookmarked",!0)}})};u.turnOnContinuousPlay=function(){u.continuousPlayEnabled(!0)};u.turnOffContinuousPlay=function(){u.continuousPlayEnabled(!1)};u.turnOnRandomPlay=function(){u.randomPlayEnabled(!0)};u.canMovePrevious=function(){return u.index()>0};u.canMoveNext=function(){return u.index()<u.maxIndex()};u.getStartingIdForRandomMode=function(n){var t=c(u.mediaId(),n);return t<u.maxIndex()?n[t+1].Id:t>0?n[t-1].Id:u.mediaId()};u.movePrevious=function(){var f=i.getMediaPosts(),n=c(u.mediaId(),f),o;return t.postViewModel.randomPlayEnabled()&&!i.randomListWasLoaded()?(o=u.mediaId(),n>0&&(o=f[n-1].Id),i.initialLoad(o,u.galleryId(),0,!0),!0):n<=0?!1:(n--,u.mediaId(f[n].Id),b(f[n]),r&&(r.play(!0),u.isPlaying(!0)),i.loadMoreAtFront(u.mediaId()),e.updateUrlHashWithHistorySupport(u.mediaId(),t.postModalExperience),!0)};u.moveNext=function(){var f=i.getMediaPosts(),n=c(u.mediaId(),f),o;return t.postViewModel.randomPlayEnabled()&&!i.randomListWasLoaded()?(o=u.mediaId(),n<u.maxIndex()&&(o=f[n+1].Id),i.initialLoad(o,u.galleryId(),0,!0),!0):n>=f.length-1?!1:(n++,u.mediaId(f[n].Id),b(f[n]),r&&(r.play(!0),u.isPlaying(!0)),i.loadMoreAtEnd(u.mediaId()),e.updateUrlHashWithHistorySupport(u.mediaId(),t.postModalExperience),!0)};u.play=function(){r&&(r.play(!0),u.isPlaying(!0))};u.pause=function(){r&&(r.pause(!0),u.isPlaying(!1))};u.share=function(){var n=u.shareUrl();wt().launchShareAction(n,t.headingShare)};u.emailShareUrl=function(){return"mailto:?subject="+u.title()+"&body="+u.url()};u.deletePost=function(){return window.confirm(t.deleteConfirmationMessage)&&jQuery.telligent.evolution.del({url:jQuery.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/media/{MediaGalleryId}/files/{FileId}.json",data:{MediaGalleryId:t.postViewModel.galleryId(),FileId:t.postViewModel.mediaId()},success:function(){window.location=t.postViewModel.galleryUrl()},defaultErrorMessage:t.deleteErrorMessage}),!1};u.closePlayer=function(){at()};u.changeView=function(){u.isMinimized(!u.isMinimized());k();vi();ft()};u.addComment=function(){if(u.canCreateComment()){l.attr("disabled","disabled");var n=l.val();n.length<=0||w.addComment(t.postViewModel.mediaId(),t.postViewModel.galleryId(),n)}};u.setIndex=function(){var n=i.getMediaPosts();u.index(c(u.mediaId(),n));u.maxIndex(n.length-1)};u.getThumbnailUrl=function(){return u.isMinimized()?u.thumbnailUrlMinimized():u.thumbnailUrlMaximized()};u.deleteComment=function(n){ko.utils.arrayForEach(u.comments(),function(t){if(t.contentId()===n){t.deleteComment();return}})}}function li(n,t){var i=this;i.url=n;i.value=t}function ai(){var n=this;n.commentId=ko.observable(0);n.contentId=ko.observable(0);n.contentTypeId=ko.observable(0);n.body=ko.observable();n.authorProfileUrl=ko.observable();n.authorAvatarUrl=ko.observable();n.authorDisplayName=ko.observable();n.authorUserId=ko.observable(0);n.dateFormatted=ko.observable();n.likeHtml=ko.observable("");n.moderateHtml=ko.observable("");n.isAuthorComment=function(){return t.userId===n.authorUserId()};n.deleteComment=function(){window.confirm(t.deleteCommentVerificationText)&&w.deleteById(t.postViewModel.mediaId(),t.postViewModel.galleryId(),n.commentId())}}function c(n,t){if(t==null)return-1;for(var i=0;i<t.length;i++)if(n==t[i].Id)return i;return-1}var w,rt,ut;ko.bindingHandlers.watermark={init:function(t){n(t).watermark();setTimeout(function(){n(t).val(n(t).attr("title"))},0)},update:function(t){n(t).val()===n(t).attr("title")||n.trim(n(t).val()).length===0?n(t).addClass("watermark"):n(t).removeClass("watermark")}};var vt=n.couto.mediamagnificent.mediaPostListLoader,yt=n.couto.mediamagnificent.galleryListLoader,pt=n.couto.mediamagnificent.urlHashTracker,d=n.couto.mediamagnificent.urlBuilder,wt=n.couto.mediamagnificent.shareMediaPostUi,bt=n.couto.mediamagnificent.mediaPostCommentsLoader,o=n(t.audioPlayerSelector),g=n('[data-container-for="PostRating"]',t.audioPlayerSelector),kt=g.html(),v=n('[data-link-for="subscribe"]',t.audioPlayerSelector),et=n('[data-image-for="postAuthorAvatar"]',t.audioPlayerSelector),dt=et.data("maxWidth")*1,gt=et.data("maxHeight")*1,ot=n('[data-image-for="commentAuthorAvatar"]',t.audioPlayerSelector),ni=ot.data("maxWidth")*1,ti=ot.data("maxHeight")*1,y=n('[data-container-for="ThumbnailImage"]',t.audioPlayerSelector),ii=y.data("widthMinimized")*1,ri=y.data("heightMinimized")*1,ui=y.data("widthMaximized")*1,fi=y.data("heightMaximized")*1,l=n('[data-input-for="addCommentBody"]',t.audioPlayerSelector),s=n('[data-container-for="Player"]',t.audioPlayerSelector),ei=s.data("width"),oi=s.data("height"),nt=n('[data-container-for="MediaPlayerControls"]',t.audioPlayerSelector),tt=n('[data-container-for="FlashDownload"]',t.audioPlayerSelector),f=n('[data-container-for="Comments"]',t.audioPlayerSelector),it=n('[data-container-for="PostContent"]',t.audioPlayerSelector),si=n('[data-container-for="PostCommentsInner"]',t.audioPlayerSelector),hi=n('[data-container-for="CommentList"]',t.audioPlayerSelector),h=n('[data-container-for="Description"]',t.audioPlayerSelector),p=!1,r=null,st=!1,u=null,i=vt({experience:t.postModalExperience,countPerViewport:1,onInitialDataReceived:function(n,r){var u=c(r,n);b(n[u]);lt();i.loadMoreAtFront(r);i.loadMoreAtEnd(r);e.updateUrlHashWithHistorySupport(t.postViewModel.mediaId(),t.postModalExperience)},onDataLoadedToFront:function(){t.postViewModel.setIndex()},onDataLoadedToEnd:function(){t.postViewModel.setIndex()}}),e=pt({onHashChangeComplete:function(){var i=e.getHashValue();i.length<=0||(u=i.split("_"),u.length>1&&u[1].toLowerCase()===t.postModalExperience.toLowerCase()&&n.telligent.evolution.get({url:t.mediaDetailsUrl,data:{fileId:u[0]},async:!1,success:function(n){n.success&&a(n.mediaId,n.mediaGalleryId)}}))},hashValuePrefix:"!"});e.urlHashTrackerSetWatcher(function(){var i=e.getHashValue();i.length>0&&!p&&(u=i.split("_"),u.length>1&&u[1].toLowerCase()===t.postModalExperience.toLowerCase()&&n.telligent.evolution.get({url:t.mediaDetailsUrl,data:{fileId:u[0]},async:!1,success:function(n){n.success&&a(n.mediaId,n.mediaGalleryId)}}))});w=bt({avatarWidth:ni,avatarHeight:ti,serverDate:t.serverDate,commentDateFormat:t.commentDateFormat,onGetCommentsComplete:function(i){for(var f=[],u="",r=0;r<i.length;r++)rt(i[r]),f.push(i[r].CommentId),u===""&&(u=i[r].CommentContentTypeId);n.telligent.evolution.post({url:t.commentsModerateLikeUiUrl,data:{contentIds:f,contentTypeId:u,mediaGalleryId:t.postViewModel.galleryId()},async:!1,cache:!1,success:function(n){n&&ut(n.moderateHtmls,n.likeHtmls)}});k()},onAddSuccess:function(i){rt(i);var r=[];r.push(i.CommentId);n.telligent.evolution.post({url:t.commentsModerateLikeUiUrl,data:{contentIds:r,contentTypeId:i.CommentContentTypeId,mediaGalleryId:t.postViewModel.galleryId()},async:!1,cache:!1,success:function(n){n&&ut(n.moderateHtmls,n.likeHtmls)}});l.val("").removeAttr("disabled");k(function(){ft();ct()})},onAddFailure:function(){l.removeAttr("disabled")},onDeleteSuccess:function(n){t.postViewModel.comments.remove(function(t){return t.commentId()===n});k(function(){ft();ct()})}});rt=function(n){var i=new ai;i.commentId(n.Id);i.contentId(n.CommentId);i.contentTypeId(n.CommentContentTypeId);i.body(n.Body);i.authorProfileUrl(n.Author.ProfileUrl);i.authorAvatarUrl(n.Author.AvatarUrlResized);i.authorDisplayName(n.Author.DisplayName.length>0?n.Author.DisplayName:n.Author.Username);i.authorUserId(n.Author.Id);i.dateFormatted(n.DateFormatted);t.postViewModel.comments.push(i)};ut=function(n,i){ko.utils.arrayForEach(t.postViewModel.comments(),function(t){n[t.contentId()]&&t.moderateHtml(n[t.contentId()]);i[t.contentId()]&&t.likeHtml(i[t.contentId()])})};t.postViewModel=new ci;ko.applyBindings(t.postViewModel,o[0]);var b=function(u){var h,c,l,f,a,s,e,o;if(t.postViewModel.clearData(),t.postViewModel.userIsRegistered(t.userIsRegistered),t.postViewModel.mediaId(u.Id),t.postViewModel.contentId(u.ContentId),t.postViewModel.contentTypeId(u.ContentTypeId),t.postViewModel.galleryId(u.MediaGalleryId),t.postViewModel.groupId(u.GroupId),t.postViewModel.url(u.Url),t.postViewModel.fileUrl(u.File.FileUrl),h=d().buildImageResizedUrl(u.ThumbnailUrl,ii,ri),c=d().buildImageResizedUrl(u.ThumbnailUrl,ui,fi),t.postViewModel.thumbnailUrlMinimized(h),t.postViewModel.thumbnailUrlMaximized(c),t.postViewModel.title(u.Title),t.postViewModel.description(u.Description),t.postViewModel.hasDescription(n.trim(u.Description).toLowerCase()!=='<div style="clear:both;"><\/div>'),u.Author&&(t.postViewModel.authorUserId(u.Author.Id),t.postViewModel.authorProfileUrl(u.Author.ProfileUrl),t.postViewModel.authorDisplayName(u.Author.DisplayName),l=d().buildImageResizedUrl(u.Author.AvatarUrl,dt,gt),t.postViewModel.authorAvatarUrl(l)),u.ExtendedAttributes)for(f=0;f<u.ExtendedAttributes.length;f++)switch(u.ExtendedAttributes[f].Key){case"Creator":t.postViewModel.creator(u.ExtendedAttributes[f].Value);break;case"Title":a=StringUtil.isNullOrEmpty(u.ExtendedAttributes[f].Value)?u.Title:u.ExtendedAttributes[f].Value;t.postViewModel.title(a)}if(t.postViewModel.fileSizeFormatted(u.FileSizeFormatted),t.postViewModel.dateFormatted(u.DateFormatted),t.postViewModel.downloads(u.Downloads),t.postViewModel.views(u.Views),u.Urls&&(t.postViewModel.shareUrl(u.Urls.ShareUrl),t.postViewModel.editUrl(u.Urls.EditUrl),t.postViewModel.downloadUrl(u.Urls.DownloadUrl)),s=[],u.Tags)for(e=0;e<u.Tags.length;e++)s.push(u.Tags[e].Value);return n.telligent.evolution.post({url:t.galleryMetaDataUrl,data:{galleryId:t.postViewModel.galleryId(),tags:s},async:!1,cache:!1,success:function(n){t.postViewModel.canDownloadPost(n.canDownloadPost);t.postViewModel.canEditPost(n.canEditPost);t.postViewModel.canDeletePost(n.canDeletePost);t.postViewModel.canRatePost(n.canRatePost);t.postViewModel.canCreateComment(n.canCreateComment);t.postViewModel.canDeleteComment(n.canDeleteComment);t.postViewModel.galleryRssUrl(n.galleryRssUrl);for(var i=0;i<n.tags.length;i++)t.postViewModel.tags.push(new li(n.tags[i].url,n.tags[i].value))}}),n.telligent.evolution.post({url:t.moderateLikeUiUrl,data:{contentId:t.postViewModel.contentId(),contentTypeId:t.postViewModel.contentTypeId()},async:!1,cache:!1,success:function(n){t.postViewModel.likeHtml(n.likeHtml);t.postViewModel.moderateHtml(n.moderateHtml)}}),t.postViewModel.rating(u.Rating),t.postViewModel.isBookmarked(u.IsBookmarked),t.postViewModel.canBookmarkPost(u.CanBookmark),t.postViewModel.canUnBookmarkPost(u.CanUnBookmark),t.postViewModel.isSubscribed(u.IsSubscribed),o=yt().getGalleryById(t.postViewModel.galleryId()),o&&(t.postViewModel.galleryName(o.Name),t.postViewModel.galleryUrl(o.Url)),t.postViewModel.setIndex(),g.html(kt),g.evolutionStarRating({value:t.postViewModel.rating(),isReadOnly:!t.postViewModel.canRatePost(),imagesPathUrl:"/Utility/images/",onRate:function(r){n.telligent.evolution.put({url:n.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/couto/mediamagnificent/{MediaGalleryId}/files/{FileId}/rate.json",data:{MediaGalleryId:t.postViewModel.galleryId(),FileId:t.postViewModel.mediaId(),Rating:r},success:function(n){t.postViewModel.rating(n.Rating);i.updateMediaPostProperty(t.postViewModel.mediaId(),"Rating",n.Rating)}})}}),v.evolutionToggleLink("val",t.postViewModel.isSubscribed()),w.getCommentsByMediaId(t.postViewModel.mediaId(),t.postViewModel.galleryId()),n.telligent.evolution.post({url:t.trackViewUrl,data:{mediaId:t.postViewModel.mediaId()}}),r&&r.load({file:t.postViewModel.fileUrl()}),!0},ht,k=function(n){var t=h.children(".scrollbar-pane");t.css("position","relative");f.css("overflow","hidden");f.css("height","");it.css("height","");h.css("height","");f.height(hi.height());it.height(Math.max(si.height(),it.height()));clearTimeout(ht);ht=setTimeout(function(){h.coutoscrollbar("unscrollbar");h.coutoscrollbar();f.coutoscrollbar("unscrollbar");f.coutoscrollbar();typeof n=="function"&&n()},500)},vi=function(){h.children(".scrollbar-pane").length>0&&h.coutoscrollbar("repaint")},ft=function(){f.children(".scrollbar-pane").length>0&&f.coutoscrollbar("repaint")},ct=function(){f.children(".scrollbar-pane").length>0&&f.coutoscrollbar("scrollto","bottom")},a=function(n,r,u){if(u)t.postViewModel.randomPlayEnabled(!0),i.initialLoad(n,r,0,!0);else if(t.postViewModel.randomPlayEnabled(!1),i.randomIsEnabled())i.initialLoad(n,r);else{var f=i.getMediaPosts(),o=c(n,f);o!==-1?(b(f[o]),e.updateUrlHashWithHistorySupport(t.postViewModel.mediaId(),t.postModalExperience),p?t.postViewModel.play():lt()):i.initialLoad(n,r)}},lt=function(){n("body").trigger("closeMediaPostModalForVideo.couto.mediaMagnificent");var i=function(){return o.animate({bottom:0},1e3)};n.when(i()).done(function(){p=!0;t.postViewModel.play()})},at=function(){r&&r.stop();var i=function(){return o.animate({bottom:-999},1e3)};n.when(i()).done(function(){t.postViewModel.clearData();t.postViewModel.isMinimized(!0);p=!1;var n=e.getHashValue();n.length>0&&(u=n.split("_"),u.length>1&&u[1].toLowerCase()===t.postModalExperience.toLowerCase()&&e.clearUrlHashWithHistorySupport())})};if(l.bind("keydown",function(n){var i=n.keyCode?n.keyCode:n.which?n.which:n.charCode;return i===13?(t.postViewModel.addComment(),!1):!0}),t.subscribeLinkOptions.changeState=function(r){n.telligent.evolution.post({url:t.subscribeUrl,data:{type:"media",subscribe:r,mediaId:t.postViewModel.mediaId()},dataType:"json",success:function(n){v.evolutionToggleLink("val",n.subscribe);t.postViewModel.isSubscribed(n.subscribe);i.updateMediaPostProperty(t.postViewModel.mediaId(),"IsSubscribed",n.subscribe)},error:n.proxy(function(){v.evolutionToggleLink("val",!r);t.postViewModel.isSubscribed(!r);i.updateMediaPostProperty(t.postViewModel.mediaId(),"IsSubscribed",!r)},this)})},v.evolutionToggleLink(t.subscribeLinkOptions),n("body").delegate('a[data-mediaid][data-galleryid][data-groupid][data-experience="Audio"]',"click",function(t){t.stopImmediatePropagation();var i=n(this);return a(i.data("mediaid"),i.data("galleryid")),!1}),location.href.indexOf("edit.aspx")===-1&&t.hashValue.length>0&&(u=t.hashValue.split("_"),u.length>1&&u[1].toLowerCase()==="audio"&&n.telligent.evolution.get({url:t.mediaDetailsUrl,data:{fileId:u[0]},async:!1,success:function(n){n.success&&a(n.mediaId,n.mediaGalleryId)}})),(jwplayer.utils.hasFlash&&jwplayer.utils.hasFlash()||jwplayer.utils.hasHTML5&&jwplayer.utils.hasHTML5())&&(st=!0),st?(s.show(),nt.show(),tt.hide(),r=jwplayer(s.attr("id")),r?r.setup({controlbar:"bottom",width:ei,height:oi,autostart:!1,volume:80,modes:[{type:"flash",src:n.telligent.evolution.site.getBaseUrl()+"Couto/AddOns/MediaMagnificent/Scripts/Library/JWPlayer/player.swf"},{type:"html5"}],events:{onComplete:function(){if(t.postViewModel.isPlaying(!1),t.postViewModel.continuousPlayEnabled())if(t.postViewModel.randomPlayEnabled()&&!i.randomListWasLoaded()){var n=t.postViewModel.mediaId(),r=i.getMediaPosts();t.postViewModel.index()<t.postViewModel.maxIndex()?n=r[t.postViewModel.index()+1].Id:t.postViewModel.index()>0&&(n=r[t.postViewModel.index()-1].Id);t.postViewModel.randomPlayEnabled(!0);i.initialLoad(n,t.postViewModel.galleryId(),0,!0)}else t.postViewModel.moveNext()},onError:function(){}}}):(s.hide(),nt.hide(),tt.show())):(s.hide(),nt.hide(),tt.show()),n("body").bind("launchAudioPlayer.couto.mediaMagnificent",function(n,t){a(t.mediaId,t.galleryId,t.makeRandom?!0:!1)}),n("body").bind("closeAudioPlayer.couto.mediaMagnificent",function(){at(!0)}),n.data(n("body").get(0),"events").deleteAudioPlayerComment==null)n("body").on("deleteAudioPlayerComment.couto.mediaMagnificent",function(n,i){t.postViewModel.deleteComment(i)});n("body").on("click",'a[href*="#!DeleteAudioPlayerComment_"]',function(){var i=n(this)[0].hash,t=i.split("_");return t.length===2&&n("body").trigger("deleteAudioPlayerComment.couto.mediaMagnificent",[t[1]]),!1});o.detach();o.css("bottom","-999px");n("body").append(o);o.show()}}})(jQuery,window);
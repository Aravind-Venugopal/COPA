(function(n){var t=null,i=function(n){function l(){document.title=u<=0?document.title.replace(e,""):" ("+u+") "+document.title.replace(e,"")}function a(t){var r=t.link.wrap("<span><\/span>").parent("span").css({position:"relative"}),i=n('<a href="#" class="read-queue-count"><\/a>');i.appendTo(r).hide().on("click",function(n){n.preventDefault();t.link.click()});return i}function v(n,t){return t=t||0,t===1?n.unreadCountMessageSingular.replace(/\{0\}/gi,t):n.unreadCountMessagePlural.replace(/\{0\}/gi,t)}function o(n,t){var r,i;n.showCount&&(r=t-n.previousCount,n.previousCount=t,n.titleCount&&(u+=r,l()),i=v(n,t),t<=0?(n.count&&n.count.fadeOut(200),n.link.attr("title",i)):(n.count=n.count||a(n),n.count.html(t).attr("title",i).fadeIn(200),n.link.attr("title",i)))}function i(t,i,r){return t.loading=!0,t.popupContentLoader.show(),n.Deferred(function(n){t.onLoad(i,r,t.filter||"",function(t){n.resolve(t)})}).promise()}function y(t){t.compiledTemplate=t.compiledTemplate||n.telligent.evolution.template.compile(t.template);t.popup=n(t.compiledTemplate(t));t.popupContentListContainer=t.popup.find(".content-list-container");t.popupContentList=t.popup.find(".content-list");t.popupContentLoader=t.popup.find(".loading");t.popup.glowPopUpPanel({cssClass:"menu read-queue queue-content "+t.popupClass,hideOnDocumentClick:!1,position:t.popupPosition,zIndex:1e3}).on("glowPopUpPanelHidden",function(){t.link.removeClass("active")}).on("glowPopUpPanelShown",function(){var n=t.popupContentListContainer.find(".scrollbar-pane");n.length>0?t.popupContentListContainer.coutoscrollbar("repaint"):t.popupContentListContainer.coutoscrollbar();t.popupContentListContainer.find(".scrollbar-pane").length>0&&t.popupContentListContainer.coutoscrollbar("scrollto","top")});if(n(document).mouseup(function(n){if(t.popup.glowPopUpPanel("isShown")){var i=t.popup.data("_glowPopUpPanel").internal.panel;if(!t.link.is(n.target)&&t.link.has(n.target).length===0&&!i.is(n.target)&&i.has(n.target).length===0){if(t.popup.glowPopUpPanel("isOpening"))return;t.popup.glowPopUpPanel("isShown")&&r(t)}}}),t.onBuildFilter!==null){var u=t.onBuildFilter(function(n){t.filter=n;t.currentPageIndex=0;i(t,t.currentPageIndex,!0).then(function(n){t.popupContentLoader.hide();f(t,n,!0)})});u&&n(u).insertBefore(t.popupContentListContainer)}}function s(n){n.popupContentList.children("li.content-item.last-item").removeClass("last-item");n.popupContentList.children("li.content-item:last").addClass("last-item")}function p(n,i){t&&r(t);t=n;n.popupContentList.html(i);s(n);n.popup.glowPopUpPanel("show",n.link);n.loading=!1;n.hasMore=n.popupContentList.children("li:last").data("hasmore")?!0:!1;n.link.addClass("active");n.onShow&&n.onShow();n.popupContentLoader.hide();n.popupContent=n.popupContentList.closest(".read-queue");n.popupContainer=n.popupContent.parent()}function r(n){n.popup.glowPopUpPanel("hide")}function f(n,t,i){i?n.popupContentList.html(t):n.popupContentList.append(t);s(n);n.popup.glowPopUpPanel("refresh");var r=n.popupContentListContainer.find(".scrollbar-pane");r.length>0?n.popupContentListContainer.coutoscrollbar("repaint"):n.popupContentListContainer.coutoscrollbar();n.loading=!1;n.hasMore=n.popupContentList.children("li:last").data("hasmore")?!0:!1;n.popupContentLoader.hide()}function w(n){n.popup.glowPopUpPanel("isOpening")||(n.popup.glowPopUpPanel("isShown")?r(n):(n.currentPageIndex=0,n.hasMore=!0,i(n,n.currentPageIndex,!0).then(function(t){p(n,t)})))}function b(t){t.link.on("click",function(n){return n.preventDefault(),w(t),!1});if(t.endlessScroll)t.popupContentListContainer.on("coutoscrollbar.scrollend",function(){return t.hasMore?t.loading?!1:(t.popupContentLoader.show(),t.currentPageIndex++,i(t,t.currentPageIndex,!0).then(function(n){t.popupContentLoader.hide();f(t,n)}),!1):!1});t.popupContentList.on("click",".content-item",function(t){t.preventDefault();var i=n(this).data("contenturl");i&&(window.location=i)});t.popupContentList.on("click","a",function(n){n.stopPropagation()})}function k(t){t.link=n(t.link)}var e=/^\([0-9]+\)\s+/,u=0,c={link:"",initialUnreadCount:0,headingLabel:"Queue",showCount:!0,endlessScroll:!1,showMoreUrl:null,showMoreLabel:null,template:"",loading:!1,titleCount:!1,previousCount:0,unreadCountMessageSingular:"You have {0} unread item",unreadCountMessagePlural:"You have {0} unread items",onShow:function(){},onLoad:function(n,t,i,r){r("")},onRefreshUnreadCount:function(n){n(5)},onBuildFilter:null,popupPosition:"down",popupClass:""},h=function(t){var r=n.extend({},c,t||{});k(r);r.link.one("click",function(n){n.preventDefault();y(r);b(r);r.link.click()});return o(r,r.initialUnreadCount),{refreshUnreadCount:function(){return r.onRefreshUnreadCount(function(n){o(r,n)})},refreshContent:function(){r.popup&&r.popup.glowPopUpPanel("isShown")&&(r.currentPageIndex=0,i(r,r.currentPageIndex,!1).then(function(n){f(r,n,!0)}))},content:function(){return r.popupContentList}}};return h.hideCurrent=function(){t&&r(t)},h}(n),u=function(t){var u=function(){t.notificationsQueue.content().on("click","a.preference",function(i){return i.preventDefault(),f(t,n(this).closest("li")),!1});t.notificationsQueue.content().on("click",".notification-preference .cancel",function(i){return i.preventDefault(),i.stopPropagation(),r(t,n(this).closest(".notification-preference")),t.preferenceUi=null,!1});t.notificationsQueue.content().on("click",".notification-preference",function(i){return i.preventDefault(),i.stopPropagation(),r(t,n(this)),t.preferenceUi=null,!1});t.notificationsQueue.content().on("click",".notification-preference .confirm",function(i){i.preventDefault();var r=n(this).closest(".notification-preference"),u=r.closest("li");return e(t,n(this).data("notificationtypeid")).then(function(){u.fadeOut(200,function(){r.remove();u.remove()});t.preferenceUi=null}),!1})};t.notificationsQueue=i({headingLabel:t.notificationsLabel,initialUnreadCount:t.notificationsUnread,link:t.notificationsLink,endlessScroll:!0,titleCount:!0,unreadCountMessageSingular:t.notificationssUnreadCountMessageSingular,unreadCountMessagePlural:t.notificationssUnreadCountMessagePlural,onLoad:function(i,r,f,e){t.isInited||(t.isInited=!0,u());t.notificationList&&t.notificationList.css({height:"auto"});n.telligent.evolution.get({url:t.notificationsUrl,data:{w_pageIndex:i},success:function(n){e(n);r&&t.notificationsQueue.refreshUnreadCount()}})},onRefreshUnreadCount:function(i){var r={IsRead:!1,PageSize:1,PageIndex:0};return r["_Filters_"+t.conversationNotificationTypeId]="Exclude",n.telligent.evolution.get({url:n.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/notifications.json",cache:!1,data:r,success:function(n){i(n.TotalCount)}})},template:t.notificationsTemplate,popupPosition:"down",popupClass:"site-user-links notifications"});n.telligent.evolution.messaging.subscribe("notification.raised",function(n){n.typeId!==t.conversationNotificationTypeId&&t.notificationsQueue.refreshUnreadCount().then(function(){t.notificationsQueue.refreshContent()})})},f=function(t,i){t.notificationList=t.notificationList||i.closest("ul");t.preferenceUi&&(r(t,t.preferenceUi),t.preferenceUi=null);t.preferenceTemplate=t.preferenceTemplate||n.telligent.evolution.template.compile(t.notificationPreferenceTemplate);t.preferenceUi=n(t.preferenceTemplate({notificationTypeName:i.data("notificationtypename"),notificationTypeId:i.data("notificationtypeid")})).hide().appendTo(i);t.preferenceUi.css({position:"absolute",top:0,left:0,zIndex:2e3,backgroundColor:"#fff"});i.addClass("with-preference");i.data("originalHeight",i.height());i.animate({height:t.preferenceUi.height()},150);t.preferenceUi.fadeTo(150,.95,function(){var n=i.closest(".content-list-container");n.find(".scrollbar-pane").length>0?n.coutoscrollbar("repaint"):n.coutoscrollbar()})},r=function(n,t){if(t){var i=t.parent();i.animate({height:i.data("originalHeight")},150);t.fadeOut(150,function(){i.removeClass("with-preference");t.remove();var n=i.closest(".content-list-container");n.find(".scrollbar-pane").length>0?n.coutoscrollbar("repaint"):n.coutoscrollbar()})}},e=function(t,i){return n.telligent.evolution.put({url:n.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/notificationpreference.json",data:{NotificationTypeId:i,IsEnabled:!1},dataType:"json"})},o=function(t){t.conversationsQueue=i({headingLabel:t.conversationsLabel,initialUnreadCount:t.conversationsUnread,link:t.conversationsLink,endlessScroll:!0,titleCount:!0,showMoreUrl:t.conversationsMoreUrl,showMoreLabel:t.conversationsMoreLabel,unreadCountMessageSingular:t.conversationsUnreadCountMessageSingular,unreadCountMessagePlural:t.conversationsUnreadCountMessagePlural,onLoad:function(i,r,u,f){n.telligent.evolution.get({url:t.conversationsUrl,data:{w_pageIndex:i},success:function(n){f(n);r&&t.conversationsQueue.refreshUnreadCount()}})},onRefreshUnreadCount:function(t){return n.telligent.evolution.get({url:n.telligent.evolution.site.getBaseUrl()+"api.ashx/v2/conversations.json",cache:!1,data:{ReadStatus:"Unread"},success:function(n){t(n.TotalCount)}})},template:t.conversationsTemplate,popupPosition:"down",popupClass:"site-user-links conversations"});n.telligent.evolution.messaging.subscribe("notification.raised",function(n){n.typeId===t.conversationNotificationTypeId&&t.conversationsQueue.refreshUnreadCount().then(function(){t.conversationsQueue.refreshContent()})});n.telligent.evolution.messaging.subscribe("ui.messageread",function(){t.conversationsQueue.refreshUnreadCount()})},s=function(t){var r=function(){var i=[],r=t.bookmarkFilter.find("a.selected").each(function(){i.push(n(this).data("contenttypeids"))});return i.join(",")};t.bookmarksList=i({headingLabel:t.bookmarksLabel,link:t.bookmarksLink,endlessScroll:!0,titleCount:!1,showCount:!1,showMoreUrl:t.bookmarksMoreUrl,showMoreLabel:t.bookmarksMoreLabel,onLoad:function(i,u,f,e){var o=f||r(t.bookmarkFilter);n.telligent.evolution.get({url:t.bookmarksUrl,data:{w_pageIndex:i,w_contentTypeIds:o},success:function(n){o&&o.length>0&&r(t.bookmarkFilter)!==o||(e(n),u&&t.bookmarksList.refreshUnreadCount())}})},onRefreshUnreadCount:function(n){n(0)},onBuildFilter:function(i){var e=n.telligent.evolution.template.compile(t.bookmarksFilterTemplate),u={contentTypeIds:"",applicationContentTypeIds:"",containerTypes:[]},f;t.bookmarksContentTypes.length>0&&(u.contentTypeIds=t.bookmarksContentTypes.substr(0,t.bookmarksContentTypes.length-1));t.bookmarksApplicationContentTypes.length>0&&(u.applicationContentTypeIds=t.bookmarksApplicationContentTypes.substr(0,t.bookmarksApplicationContentTypes.length-1));t.bookmarksContainerContentTypes.length>0&&(f=t.bookmarksContainerContentTypes.split(","),n.each(f,function(n,t){if(t&&t.length>0){var i=t.split(":",2);i.length===2&&u.containerTypes.push({name:i[1],id:i[0]})}}));t.bookmarkFilter=n(e(u));t.bookmarkFilter.find("a:first").addClass("selected");t.bookmarkFilter.on("click","a",function(u){u.preventDefault();u.stopPropagation();var f=n(u.target);f.closest("ul").find("a").removeClass("selected");f.addClass("selected");i(r(t.bookmarkFilter))});return t.bookmarkFilter},template:t.bookmarksTemplate,popupPosition:"down",popupClass:"site-user-links bookmarks"})},h={register:function(t){t.notificationsLink.length>0&&u(t);t.conversationsLink.length>0&&o(t);t.bookmarksLink.length>0&&s(t);n("body").trigger("overrideSiteTabWidthCheck.couto.addOnFramework",970);n("body").trigger("addSiteLinkTab.couto.addOnFramework",{element:n(t.browseGroupsLinkId),sortOrder:1})}};n.telligent=n.telligent||{};n.telligent.evolution=n.telligent.evolution||{};n.telligent.evolution.widgets=n.telligent.evolution.widgets||{};n.telligent.evolution.widgets.siteUserLinks=h})(jQuery);